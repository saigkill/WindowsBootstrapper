---
trigger:
  branches:
    include:
      - main
      - develop
  tags:
    include:
      - v*

pool:
  vmImage: 'windows-latest'

variables:
  pwshVersion: '7.4.0'

stages:
  - stage: BuildAndTest
    displayName: Build & Test
    jobs:
      - job: Build_Test
        displayName: Lint, Test, Validate, Package
        steps:
          - task: PowerShell@2
            displayName: Install PowerShell Core
            inputs:
              targetType: inline
              script: |
                choco install powershell-core --version $(pwshVersion) -y
                Write-Host "Installed PowerShell $(pwshVersion)"

          - task: PowerShell@2
            displayName: Show PowerShell Version
            inputs:
              targetType: inline
              pwsh: true
              script: |
                $PSVersionTable

          # PSScriptAnalyzer
          - task: PowerShell@2
            displayName: Run PSScriptAnalyzer
            inputs:
              targetType: inline
              pwsh: true
              script: |
                Install-Module PSScriptAnalyzer -Force -Scope CurrentUser
                Invoke-ScriptAnalyzer -Path . -Recurse -Severity Warning,Error

          # Pester Tests (optional – kannst du nach und nach füllen)
          - task: PowerShell@2
            displayName: Run Pester tests
            inputs:
              targetType: inline
              pwsh: true
              script: |
                Install-Module Pester -Force -Scope CurrentUser
                if (Test-Path ".\tests") {
                  Invoke-Pester -Path .\tests -Output Detailed
                }
                else {
                  Write-Host "No tests folder found – skipping Pester."
                }

          # Static Code Validation
          - task: PowerShell@2
            displayName: Validate Script Signing
            inputs:
              targetType: inline
              script: |
                Get-AuthenticodeSignature ./bootstrap.ps1

          # JSON Config Validation
          - task: PowerShell@2
            displayName: Validate JSON configuration
            inputs:
              targetType: inline
              pwsh: true
              script: |
                $configDir = Join-Path $PSScriptRoot "config"
                $files = @(
                  Join-Path $configDir "config.json"                  
                )

                foreach ($file in $files) {
                  if (Test-Path $file) {
                    Write-Host "Validating JSON: $file"
                    try {
                      $null = Get-Content $file -Raw | ConvertFrom-Json
                      Write-Host "OK: $file"
                    }
                    catch {
                      Write-Error "Invalid JSON in $file $($_.Exception.Message)"
                      throw
                    }
                  }
                  else {
                    Write-Host "Skipping missing config file: $file"
                  }
                }

          # Package bootstrapper output
          - task: PowerShell@2
            displayName: Prepare bootstrapper artifact
            inputs:
              targetType: inline
              pwsh: true
              script: |
                New-Item -ItemType Directory -Path "$(Build.SourcesDirectory)\output" -Force | Out-Null

                Copy-Item "$(Build.SourcesDirectory)\bootstrap.ps1" "$(Build.SourcesDirectory)\output\" -Force
                Copy-Item "$(Build.SourcesDirectory)\version.json" "$(Build.SourcesDirectory)\output\" -Force -ErrorAction SilentlyContinue
                Copy-Item "$(Build.SourcesDirectory)\config" "$(Build.SourcesDirectory)\output\config" -Recurse -Force
                Copy-Item "$(Build.SourcesDirectory)\modules" "$(Build.SourcesDirectory)\output\modules" -Recurse -Force
                Copy-Item "$(Build.SourcesDirectory)\external" "$(Build.SourcesDirectory)\output\external" -Recurse -Force          

          # Mirror to GitHub
          - task: Bash@3
            inputs:
              targetType: 'inline'
              script: |             
                if [ -d "WindowsBootstrapper" ]; then
                  rm -rf "WindowsBootstrapper"
                  echo "Das Verzeichnis 'WindowsBootstrapper' wurde gelöscht."
                else
                  echo "Das Verzeichnis 'WindowsBootstrapper' existiert nicht."
                fi
          
                git clone --mirror https://saigkill:$(AzurePAT)@dev.azure.com/saigkill/WindowsBootstrapper/_git/WindowsBootstrapper ./WindowsBootstrapper --verbose
                cd WindowsBootstrapper
                git remote add github https://saigkill:$(GithubPAT)@github.com/saigkill/WindowsBootstrapper.git
                git push github --mirror
            displayName: 'Mirror to Github'

          # Create ZIP archive
          - task: ArchiveFiles@2      
            inputs:
              rootFolderOrFile: '$(Build.SourcesDirectory)\output'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.SourcesDirectory)\output\WindowsBootstrapper.zip'
              replaceExistingArchive: true
            displayName: 'Create ZIP'

          # Publish Artifacts
          - task: PublishPipelineArtifact@1
            displayName: Publish bootstrapper artifact
            inputs:
              targetPath: '$(Build.SourcesDirectory)\output\WindowsBootstrapper.zip'
              artifact: 'windows-bootstrap'
              publishLocation: 'pipeline'

# ---------------------------------------------------------
#  STAGE: RELEASE (nur bei Tags)
# ---------------------------------------------------------
  - stage: Release
    displayName: "Create GitHub Release"
    condition: startsWith(variables['Build.SourceBranch'], 'refs/tags/')
    jobs:
    - job: ReleaseJob
      pool:
        vmImage: 'windows-latest'
      steps:

      - download: current
        artifact: windows-bootstrap      
    
      - task: GitHubRelease@1
        inputs:
          gitHubConnection: 'github.com_saigkill'
          repositoryName: 'saigkill/WindowsBootstrapper'
          action: 'create'
          tagSource: 'gitTag'
          assets: $(Pipeline.Workspace)/windows-bootstrap/*.zip
          title: 'Release $(Build.SourceBranchName)'
          isDraft: false
          isPreRelease: false
        displayName: 'Create GitHub Release'
